name: Build UC2

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      buildType:
        description: 'Build Type'
        required: false
        default: ''
        type: choice
        options:
          - 'Debug'
          - 'Release'
  push:
    paths-ignore:
      - ".gitignore"
      - "AUTHORS.TXT"
      - "COPYING"
      - "COPYING.LGPL2"
      - "COPYING_GLIB"
      - "CREDITS.TXT"
      - "ChangeLog"
      - "README.md"
      - "docs/**"
  pull_request:

env:
  # Specify build type either according to the tag release or manual override
  BUILD_TYPE: ${{ inputs.buildType != '' && inputs.buildType || startsWith(github.ref, 'refs/tags') && 'Release' || 'Debug' }}

jobs:
  Macos:
    runs-on: ${{ matrix.config.os }}
    name: ${{ matrix.config.name }} - ${{ matrix.compiler }}
    strategy:
      fail-fast: false
      matrix:
        config:
          - {
            os: macos-latest,
            arch: arm64-v8a,
            name: 'android cmake',
            artifact: 'Android-arm64-v8a.7z',
            archiver: '7za a',
            generators: 'Ninja'
          }
        compiler: [ gcc ]
    steps:
      - uses: actions/checkout@v4
      - name: 'ðŸš§ Mac build'
        if: contains(matrix.config.name, 'macos')
        shell: bash
        run: |
          ninja --version
          cmake --version
          mkdir build
          mkdir instdir
          cmake \
            -S . \
            -B . \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -G "${{ matrix.config.generators }}" \
            -DCMAKE_INSTALL_PREFIX:PATH=instdir \
            -DBUILD_SHARED_LIBS=${{ matrix.config.shared }}
          cmake --build . --config ${{ env.BUILD_TYPE }}
          cmake --install . --strip
          ctest -VV -C ${{ env.BUILD_TYPE }}

      - name: 'ðŸš§ Android arm64-v8a build'
        if: contains(matrix.config.name, 'android')
        shell: bash
        run: |
          mkdir build
          mkdir instdir
          cmake . -DCMAKE_TOOLCHAIN_FILE="$ANDROID_NDK/build/cmake/android.toolchain.cmake" \
          	-DANDROID_PLATFORM=android-28 \
            -DANDROID_NDK="$ANDROID_NDK" \
            -DANDROID_ABI=${{ matrix.config.arch }} \
            -DOLP_SDK_ENABLE_TESTING=NO \
            -DOLP_SDK_BUILD_EXAMPLES=ON \
            -S . \
            -B . \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -G "${{ matrix.config.generators }}" \
            -DCMAKE_INSTALL_PREFIX:PATH=instdir
          cmake --build . --config ${{ env.BUILD_TYPE }}
          cmake --install . --strip

      - name: 'ðŸš§ AVD Cache'
        if: contains(matrix.config.name, 'android')
        uses: actions/cache@v4
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-28

      - name: 'ðŸ“¦ Pack artifact'
        if: always()
        shell: bash
        working-directory: instdir
        run: |
          ls -laR
          ${{ matrix.config.archiver }} ../${{ matrix.config.artifact }} . ../test*

      - name: 'ðŸ“¤ Upload artifact'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          path: ./${{ matrix.config.artifact }}
          name: ${{ matrix.config.artifact }}
